
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>節奏練習遊戲</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; text-align: center; }
    select, button { font-size: 16px; margin: 8px; }
    .arrow { display: inline-block; width: 50px; height: 50px; background-size: cover; }
    #bar-container { width: 60%; height: 10px; background: #ccc; margin: 20px auto; position: relative; }
    #bar-progress { height: 100%; background: green; width: 0%; position: absolute; top: 0; left: 0; }
    #game { margin-top: 20px; min-height: 60px; }
    #result { margin-top: 20px; font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>節奏練習遊戲（可執行）</h1>

  <div>
    <label>鍵種：
      <select id="main-mode">
        <option value="4K">4K</option>
        <option value="8K">8K</option>
        <option value="9K">9K</option>
      </select>
    </label>

    <label>子模式：
      <select id="sub-mode">
        <option value="floor">地板</option>
        <option value="11">11鍵（資料庫）</option>
      </select>
    </label>

    <label>限時：
      <select id="speed">
        <option value="300">0.3秒</option>
        <option value="500">0.5秒</option>
        <option value="700">0.7秒</option>
        <option value="1000" selected>1秒</option>
        <option value="1500">1.5秒</option>
        <option value="1750">1.75秒</option>
        <option value="2000">2秒</option>
      </select>
    </label>

    <button onclick="startGame()">開始</button>
  </div>

  <div id="bar-container"><div id="bar-progress"></div></div>
  <div id="game"></div>
  <div id="result"></div>

  <script>
    const keyMap = { '1':'左下', '2':'下', '3':'右下', '4':'左', '5':'中', '6':'右', '7':'左上', '8':'上', '9':'右上' };
    const keyPool = {
      "4K": ['2','4','6','8'],
      "8K": ['1','2','3','4','6','7','8','9'],
      "9K": ['1','2','3','4','6','7','8','9'] // 中鍵會動態插入
    };

    let sequence = [], current = 0, timeLimit = 1000, mode = "8K", sub = "floor";
    let timeout, barStart = 0;
    const gameEl = document.getElementById("game");
    const bar = document.getElementById("bar-progress");
    const result = document.getElementById("result");

    function renderArrows(seq, highlight = -1) {
      gameEl.innerHTML = "";
      seq.forEach((k, i) => {
        const dir = keyMap[k];
        const color = i === highlight ? "綠" : (i === 7 ? "紅" : "藍");
        const img = document.createElement("div");
        img.className = "arrow";
        img.style.backgroundImage = `url('${color + dir}.jpg')`;
        gameEl.appendChild(img);
      });
    }

    function generateFloorSet(mode) {
      let pool = [...keyPool[mode]];
      let seq = [];
      for (let i = 0; i < 11; i++) {
        seq.push(pool[Math.floor(Math.random() * pool.length)]);
      }
      if (mode === "9K") {
        let insertIndex = Math.floor(Math.random() * 11);
        seq[insertIndex] = '5'; // 插入中鍵
      }
      return seq;
    }

    async function loadDataSet(mode) {
      let res = await fetch("8K-11.json");
      let data = await res.json();
      let seq = data[Math.floor(Math.random() * data.length)];
      if (mode === "9K") {
        let i = Math.floor(Math.random() * 11);
        seq[i] = '5';
      }
      return seq;
    }

    function runBar() {
      bar.style.width = "0%";
      barStart = Date.now();
      function update() {
        let pct = ((Date.now() - barStart) / timeLimit) * 100;
        bar.style.width = Math.min(pct, 100) + "%";
        if (pct < 100) requestAnimationFrame(update);
        else miss();
      }
      update();
    }

    function miss() {
      result.textContent = "MISS！";
      setTimeout(startGame, 1000);
    }

    async function startGame() {
      clearTimeout(timeout);
      result.textContent = "";
      mode = document.getElementById("main-mode").value;
      sub = document.getElementById("sub-mode").value;
      timeLimit = parseInt(document.getElementById("speed").value);
      if (sub === "floor") {
        sequence = generateFloorSet(mode);
      } else if (sub === "11" && (mode === "8K" || mode === "9K")) {
        sequence = await loadDataSet(mode);
      } else {
        result.textContent = "目前僅支援地板與8K/9K-11鍵資料庫模式";
        return;
      }
      current = 0;
      renderArrows(sequence);
      runBar();
    }

    document.addEventListener("keydown", (e) => {
      if (!"123456789".includes(e.key)) return;
      if (sequence[current] === e.key) {
        renderArrows(sequence, current);
        current++;
        if (current === sequence.length) {
          result.textContent = "成功！";
          setTimeout(startGame, 1000);
        }
      } else {
        result.textContent = "錯誤，重出";
        setTimeout(startGame, 1000);
      }
    });
  </script>
</body>
</html>
